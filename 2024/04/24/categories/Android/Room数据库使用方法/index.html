<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="清风明月博客">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.3.0">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://Visen123.github.io">
    <!--SEO-->

<meta name="keywords" content="Android" />


<meta name="description" content="Room数据库的使用方法目录1、添加Room数据库的依赖2、Entity——定义实体类2.1 定义主键——PrimaryKey2.2 字段注解——ColumnInfo3、Dao——定义数据访问对..." />


<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />
    <!--Title-->

<title>
    
    Room数据库的简单使用方法 |
    
    清风明月博客
</title>

<link rel="alternate" href="/atom.xml" title="清风明月博客" type="application/atom+xml">


<link rel="icon" href="/favicon.ico">

    


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.7.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">

    
<div class="hide">
    <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cspan class='cnzz_stat_icon_1263868967 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1263868967%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script>
</div>




    

<meta name="generator" content="Hexo 5.4.0"></head>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->
<body>
    <header class="main-header"  style="background-image:url(
    /./img/beiixin.jpg)"
     >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='清风明月'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
            <!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
            <img src="/img/branding.png" alt="Snippet 博客主题" class="img-responsive center-block">
            
        </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                        <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="https://Visen123.github.io">
                        清风明月博客</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                        <li role="presentation" class="text-center">
                            <a href="/"><i class="fa "></i>
                                首页</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Android/"><i class="fa "></i>
                                Android</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/Python/"><i class="fa "></i>
                                Python</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/小程序/"><i class="fa "></i>
                                小程序</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/HarmonyOS/"><i class="fa "></i>
                                HarmonyOS</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/前端/"><i class="fa "></i>
                                前端</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/后端/"><i class="fa "></i>
                                后端</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/categories/工具/"><i class="fa "></i>
                                工具</a>
                        </li>
                        
                        <li role="presentation" class="text-center">
                            <a href="/archives/"><i class="fa "></i>
                                时间轴</a>
                        </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Room数据库的简单使用方法">
            
            Room数据库的简单使用方法
            
        </h1>
        <div class="post-meta">
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a class="category-link" href="/categories/Android/">Android</a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
        </span>
    </span>
    
    
    
    <span class="fa-wrap">
        <i class="fa fa-clock-o"></i>
        <span class="date-meta">
            2024/04/24</span>
    </span>
    
    
</div>
        
        
    </div>
    
    <div class="post-body post-content">
        <p>Room数据库的使用方法<br>目录<br>1、添加Room数据库的依赖<br>2、Entity——定义实体类<br>2.1 定义主键——PrimaryKey<br>2.2 字段注解——ColumnInfo<br>3、Dao——定义数据访问对象<br>4、Database——数据库<br>4.1 通过回调观察数据库是否创建成功<br>5、使用时注意点<br>6、编写异步 DAO 查询<br>6.1 写异步单次查询<br>6.2 编写可观察查询<br>参考文档：<br>[1] 使用 Room 实体定义数据<br>[2] 使用 Android Jetpack 的 Room 部分将数据保存到本地数据库。<br>[3] 实体类介绍<br>[4] RoomAPI、依赖<br>[5] 编写异步Dao查询</p>
<p>1、添加Room数据库的依赖<br>//Room<br>implementation “androidx.room:room-runtime:2.6.1”<br>annotationProcessor “androidx.room:room-compiler:2.6.1”</p>
<p>//Rxjava<br>implementation “androidx.room:room-rxjava3:2.6.1”</p>
<p>Room是由三大部分组成的：</p>
<p>Entity：数据库中表对应的Java实体<br>DAO：操作数据库的方法<br>Database：创建数据库</p>
<p>2、Entity——定义实体类<br>@Entity:</p>
<p>用于定义数据库表结构。<br>包含以下常用属性:<br>tableName: 指定表名。<br>primaryKeys: 指定主键字段。<br>indices: 定义索引。<br>foreignKeys: 定义外键关系<br>默认情况下，Room 将类名称用作数据库表名称。如果您希望表具有不同的名称，请设置 @Entity 注解的 tableName 属性。</p>
<p>同样，Room 默认使用字段名称作为数据库中的列名称。</p>
<p>@Entity(tableName = “users”)<br>public class User {<br>    @PrimaryKey(autoGenerate = true)<br>    public int id;</p>
<pre><code>@ColumnInfo(name = &quot;first_name&quot;)
public String firstName;

@ColumnInfo(name = &quot;last_name&quot;)
public String lastName;
</code></pre>
<p>}</p>
<p>2.1 定义主键——PrimaryKey<br>每个 Room 实体都必须定义一个主键，用于唯一标识相应数据库表中的每一行。</p>
<p>@PrimaryKey:<br>用于标记主键字段。<br>包含以下常用属性:<br>autoGenerate: 是否自动生成主键值。<br>注意：自增主键必须为int型。<br>2.2 字段注解——ColumnInfo<br>@ColumnInfo:<br>用于定义表字段。<br>包含以下常用属性:<br>name: 指定字段名，也就是表的列名<br>typeAffinity: 指定字段类型。<br>defaultValue：设置默认值，未指定值时的默认值<br>通过 typeAffinity 属性,可以指定字段的数据类型,如 TEXT、INTEGER 等。</p>
<p>📌注意数据需要均为Public</p>
<p>@Entity<br>public class HistoryData {<br>    @PrimaryKey(autoGenerate = true)<br>    public int id;</p>
<pre><code>@ColumnInfo(typeAffinity = ColumnInfo.TEXT)
public LocalDate birthDate;

@ColumnInfo(name = &quot;Name&quot;)
public String name;

@ColumnInfo(defaultValue = &quot;18&quot;)
public int age;
</code></pre>
<p>}</p>
<p>在这个例子中,birthDate 字段在数据库中会被存储为 TEXT 类型。</p>
<p>3、Dao——定义数据访问对象<br>常用注解包括：</p>
<p>@Query:<br>用于定义数据库查询语句。<br>可以返回 Flowable、Observable、Single、Maybe 等 RxJava 类型。<br>@Insert、@Update、@Delete:<br>用于定义数据库增、改、删操作。<br>可以返回 long、int、void 等类型,表示受影响的行数。<br>@Dao<br>public interface HistoryDao {</p>
<pre><code>/**
 * 向数据库添加数据
 *
 * @param data
 */
@Insert
void insertData(HistoryData data);


/**
 * 删除数据库所有数据
 */
@Query(&quot;DELETE FROM HistoryData&quot;)
void deleteDataAll();
</code></pre>
<p>}</p>
<p>4、Database——数据库<br>以下代码定义了用于保存数据库的 HistoryDatabase 类。 HistoryDatabase 定义数据库配置，并作为应用对持久性数据的主要访问点。数据库类必须满足以下条件：</p>
<p>该类必须带有 @Database 注解，该注解包含列出所有与数据库关联的数据实体的 entities 数组。<br>该类必须是一个抽象类，用于扩展 RoomDatabase。<br>对于与数据库关联的每个 DAO 类，数据库类必须定义一个具有零参数的抽象方法，并返回 DAO 类的实例。<br>@Database(entities = HistoryData.class, version = 1)<br>public abstract class HistoryDatabase extends RoomDatabase {<br>    public abstract HistoryDao historyDao();<br>}</p>
<p>请注意：</p>
<p>📌如果您的应用在单个进程中运行，在实例化 HistoryDatabase 对象时应遵循单例设计模式。每个 RoomDatabase 实例的成本相当高，而您几乎不需要在单个进程中访问多个实例。</p>
<p>用法举例：</p>
<p>@Database(entities = HistoryData.class, version = 1)<br>public abstract class HistoryDatabase extends RoomDatabase {</p>
<pre><code>private static volatile HistoryDatabase historyDB = null;

//单例模式双检锁
public static HistoryDatabase getInstance(Context context) &#123;
    if (historyDB == null) &#123;
        synchronized (HistoryDatabase.class) &#123;
            if (historyDB == null) &#123;
                historyDB = Room.databaseBuilder(context.getApplicationContext(), HistoryDatabase.class, &quot;location_History&quot;).build();
            &#125;
        &#125;
    &#125;
    return historyDB;
&#125;

public abstract HistoryDao historyDao();
</code></pre>
<p>}</p>
<p>📌如果您的应用在多个进程中运行，请在数据库构建器调用中包含 enableMultiInstanceInvalidation()。这样，如果您在每个进程中都有一个 AppDatabase 实例，可以在一个进程中使共享数据库文件失效，并且这种失效会自动传播到其他进程中 AppDatabase 的实例。</p>
<p>用法举例：</p>
<p>@Database(entities = HistoryData.class, version = 1)<br>public abstract class HistoryDatabase extends RoomDatabase {</p>
<pre><code>public static HistoryDatabase getDatabase(Context context) &#123;
    return Room.databaseBuilder(context.getApplicationContext(),
                    HistoryDatabase.class, &quot;chat_database&quot;)
            .enableMultiInstanceInvalidation()
            .build();
&#125;

public abstract HistoryDao historyDao();
</code></pre>
<p>}</p>
<p>4.1 通过回调观察数据库是否创建成功<br>通过RoomDatabase提供的Callback()回调方法观测数据库状态。</p>
<p>Callback提供了三个回调方法：分别是数据库第一次被创建时调用，数据库打开时调用，数据库被销毁迁移后调用</p>
<p>我们在创建数据库时添加上这个回调方法的实现类即可：</p>
<p>@Database(entities = HistoryData.class, version = 1,exportSchema = false)<br>public abstract class HistoryDatabase extends RoomDatabase {<br>    public abstract HistoryDao historyDao();</p>
<pre><code>private static volatile HistoryDatabase historyDB = null;

public static HistoryDatabase getInstance(Context context) &#123;
    if (historyDB == null) &#123;
        synchronized (HistoryDatabase.class) &#123;
            if (historyDB == null) &#123;
                historyDB = Room.databaseBuilder(context, HistoryDatabase.class, &quot;locationHistory&quot;)
                        .addCallback(roomCallback)
                        .build();
            &#125;
        &#125;
    &#125;
    return historyDB;
&#125;

// 回调函数，可在数据库创建、打开和关闭时执行操作
private static RoomDatabase.Callback roomCallback = new RoomDatabase.Callback() &#123;
    @Override
    public void onCreate(@NonNull SupportSQLiteDatabase db) &#123;
        super.onCreate(db);
        Log.d(&quot;HistoryDatabase&quot;, &quot;Database created successfully&quot;);
    &#125;

&#125;;
</code></pre>
<p>}</p>
<p>5、使用时注意点<br>为防止查询阻止界面，Room 不允许在主线程上访问数据库。 此限制意味着您必须将DAO 查询设为异步。Room 库包含与多个不同框架的集成，以提供异步查询执行功能。</p>
<p>// 创建一个ExecutorService<br>ExecutorService executor = Executors.newSingleThreadExecutor();</p>
<p>// 提交删除操作到ExecutorService中执行<br>executor.submit(() -&gt; {<br>    HistoryData data = new HistoryData();<br>    data.setLocationName(“天津”);</p>
<pre><code>HistoryDatabase.getInstance(getContext()).historyDao().insertData(data);

//在主线程中更改UI
runOnUiThread(() -&gt; &#123;

&#125;);
</code></pre>
<p>});</p>
<p>// 关闭ExecutorService<br>executor.shutdown();</p>
<p>6、编写异步 DAO 查询<br>Java 与 RxJava</p>
<p>如果您的应用使用 Java 编程语言，则您可以使用 RxJava 框架的专用返回类型编写异步 DAO 方法。Room 支持以下 RxJava 2 返回值类型：</p>
<p>对于单次查询，Room 2.1 及更高版本支持 Completable、Single<T> 和 Maybe<T> 返回值类型。<br>对于可观察查询，Room 支持 Publisher<T>、Flowable<T> 和 Observable<T> 返回值类型。<br>此外，Room 2.3 及更高版本支持 RxJava 3。</p>
<p>📌注意：如需将 RxJava 与 Room 搭配使用，您必须在 build.gradle 文件中添加 room-rxjava2 工件或 room-rxjava3 工件。如需了解详情，请参阅声明依赖项。</p>
<p>6.1 写异步单次查询<br>单次查询是指仅执行一次并在执行时获取数据快照的数据库操作。以下是异步单次查询的一些示例：</p>
<p>@Dao<br>public interface UserDao {<br>    @Insert(onConflict = OnConflictStrategy.REPLACE)<br>    public Completable insertUsers(List<User> users);</p>
<pre><code>@Update
public Completable updateUsers(List&lt;User&gt; users);

@Delete
public Completable deleteUsers(List&lt;User&gt; users);

@Query(&quot;SELECT * FROM user WHERE id = :id&quot;)
public Single&lt;User&gt; loadUserById(int id);

@Query(&quot;SELECT * from user WHERE region IN (:regions)&quot;)
public Single&lt;List&lt;User&gt;&gt; loadUsersByRegion(List&lt;String&gt; regions);
</code></pre>
<p>}</p>
<p>6.2 编写可观察查询<br>可观察查询是指在查询引用的任何表发生更改时发出新值的读取操作。</p>
<p>您可能需要用到可观察查询的一种情形是，帮助您在向底层数据库中插入项或者更新或移除其中的项时及时更新显示的列表项。下面是可观察查询的一些示例：</p>
<p>@Dao<br>public interface UserDao {<br>    @Query(“SELECT * FROM user WHERE id = :id”)<br>    public Flowable<User> loadUserById(int id);</p>
<pre><code>@Query(&quot;SELECT * from user WHERE region IN (:regions)&quot;)
public Flowable&lt;List&lt;User&gt;&gt; loadUsersByRegion(List&lt;String&gt; regions);
</code></pre>
<p>}</p>

    </div>
    <div align="center">
     <p style="text-align:center; color:orange; font-size:26px">安卓学习教程公众号</p>
       <img src="/./img/ercode.jpg" width="258" height="258">
     </div>
    
    <div class="reward" ontouchstart>
    <div class="reward-wrap">赏
        <div class="reward-box">
            
            
            <span class="reward-type">
                <img class="wechat" src="/./img/reward-wepay.jpg"><b>微信打赏</b>
            </span>
            
        </div>
    </div>
    <p class="reward-tip">
        祝你事业顺心，富贵吉祥，赞赏鼓励
    </p>
</div>
    
    <div class="post-footer">
        <div>
            
            转载声明：
            商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="" target="_blank">清风明月</a>
            
            
        </div>
        <div>
            
        </div>
    </div>
</article>
<div class="article-nav prev-next-wrap clearfix">
    
    <a href="/2024/04/28/categories/Android/%E7%94%A8KotlinCompose%E6%89%93%E9%80%A0%E7%9A%84%E7%82%AB%E5%BD%A9%E6%95%88%E6%9E%9C%E5%BA%93/" class="pre-post btn btn-default" title='用KotlinCompose打造的炫彩效果库'>
        <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
        <span class="hidden-xs">
            用KotlinCompose打造的炫彩效果库</span>
    </a>
    
    
    <a href="/2024/03/10/categories/Android/Android-Jetpack%E7%BB%84%E4%BB%B6%E7%AE%80%E4%BB%8B/" class="next-post btn btn-default" title='Android-Jetpack组件简介'>
        <span class="hidden-lg">下一篇</span>
        <span class="hidden-xs">
            Android-Jetpack组件简介</span><i class="fa fa-angle-right fa-fw"></i>
    </a>
    
</div>

<div id="comments">
    
    
<div class="utteranc">
  
  <script
    src='https://utteranc.es/client.js'
    repo='yansil/snippet-comment'
    issue-term='pathname'
    issue-number=''
    theme='github-light'
    label=''
    crossorigin='anonymous'
    async
  ></script>
</div>



</div>

                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">
            文章目录
        </h3>
        
        <p>暂无目录</p>
        
    </div>
</aside>
                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>
<a id="back-to-top" class="icon-btn hide">
    <i class="fa fa-chevron-up"></i>
</a>
    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>
            </div>
            <div class="col-sm-12">
                <span>Copyright &copy;
                    2021
                    
                </span> |
                <span>
                    Powered by <a href="//yansil.github.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span>
            </div>
        </div>
    </div>
</div>




<script src="/js/app.js?rev=@@hash.js"></script>

</body>
</html>